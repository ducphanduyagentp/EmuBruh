<html>
    <title>Emu Bruh</title>
    <head>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://github.com/AlexAltea/keystone.js/releases/download/v0.9.1/keystone.min.js"></script>
        <script src="https://github.com/AlexAltea/unicorn.js/releases/download/v1.0/unicorn.min.js"></script>
        <script>
            // Initialize engine
            var e = new uc.Unicorn(uc.ARCH_X86, uc.MODE_64);
            var result = [];
            var begin;
            var until;
            var step = 0;

            function prepareEmu() {
                var assembly = $("#input_asm").val();

                var a = new ks.Keystone(ks.ARCH_X86, ks.MODE_64);
                a.option(ks.OPT_SYNTAX, ks.OPT_SYNTAX_INTEL);

                result = [];
                var code = a.asm(assembly);
                assembly = assembly.replace(/\n*$/, '').split('\n')

                for (var i = 0; i < assembly.length; i++) {
                    asm_line = a.asm(assembly[i]);
                    result.push(asm_line);
                }

                a.close();

                var addr = 0x10000;

                // Write registers and memory
                e.reg_write_i64(uc.X86_REG_RAX, 0x0);
                e.reg_write_i64(uc.X86_REG_RBX, 0x0);
                e.reg_write_i64(uc.X86_REG_RCX, 0x0);
                e.reg_write_i64(uc.X86_REG_RDX, 0x0);
                e.reg_write_i64(uc.X86_REG_RSI, 0x0);
                e.reg_write_i64(uc.X86_REG_RDI, 0x0);

                e.mem_map(addr, 4*1024, uc.PROT_ALL);
                e.mem_write(addr, code)
                begin = addr;
                until = begin + code.length;
            }

            function runEmu() {
                prepareEmu();
                e.emu_start(begin, until, 0, 0);
                displayRegs();
            }

            function stepEmu() {
                if (step == 0) {
                    prepareEmu();
                }
                step++;
                e.emu_start(begin, until, 0, step);   
                displayRegs();
            }

            function displayRegs() {
                // Read registers
                var rax = e.reg_read_i64(uc.X86_REG_RAX);
                var rbx = e.reg_read_i64(uc.X86_REG_RBX);
                var rcx = e.reg_read_i64(uc.X86_REG_RCX);
                var rdx = e.reg_read_i64(uc.X86_REG_RDX);
                var rdi = e.reg_read_i64(uc.X86_REG_RDI);
                var rsi = e.reg_read_i64(uc.X86_REG_RSI);
                $("#reg_rax").html(rax);
                $("#reg_rbx").html(rbx);
                $("#reg_rcx").html(rcx);
                $("#reg_rdx").html(rdx);
                $("#reg_rdi").html(rdi);
                $("#reg_rsi").html(rsi);
            }

            function resetEmu() {
                e = new uc.Unicorn(uc.ARCH_X86, uc.MODE_64);
                step = 0;
                $("#reg_rax").html(0);
                $("#reg_rbx").html(0);
                $("#reg_rcx").html(0);
                $("#reg_rdx").html(0);
                $("#reg_rdi").html(0);
                $("#reg_rsi").html(0);
            }
        </script>
        <style>
            .regs {
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div>
            <textarea id="input_asm" rows="20" cols="50"></textarea>
            <br><br>
            <div>
                RAX = <div class="regs" id="reg_rax">0</div>
            </div>
            <div>
                RBX = <div class="regs" id="reg_rbx">0</div>
            </div>
            <div>
                RCX = <div class="regs" id="reg_rcx">0</div>
            </div>
            <div>
                RDX = <div class="regs" id="reg_rdx">0</div>
            </div>
            <div>
                RDI = <div class="regs" id="reg_rdi">0</div>
            </div>
            <div>
                RSI = <div class="regs" id="reg_rsi">0</div>
            </div>
            <br><br>
            <button type="button" onclick="runEmu()"> Run </button>
            <button type="button" onclick="stepEmu()"> Step </button>
            <button type="button" onclick="resetEmu()"> Reset </button>
        </div>
    </body>
</html>